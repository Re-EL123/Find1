<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find One â€” Verify Sign Up</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    h1 { margin-bottom: 10px; font-size: 28px; }
    p { font-size: 14px; opacity: 0.8; }
    video, canvas {
      width: 250px;
      height: 250px;
      border-radius: 50%;
      border: 3px solid #38bdf8;
      object-fit: cover;
      margin: 15px 0;
    }
    button {
      background: #38bdf8;
      border: none;
      padding: 12px 25px;
      border-radius: 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s ease;
    }
    button:hover { background: #0ea5e9; }
    #message { margin-top: 15px; font-size: 14px; color: #facc15; }
  </style>
</head>
<body>
  <h1>Verify Your Account</h1>
  <p id="statusMsg">Checking account status...</p>

  <video id="camera" autoplay playsinline style="display:none;"></video>
  <canvas id="snapshot" style="display:none;"></canvas>

  <button id="captureBtn" style="display:none;">Capture Photo</button>
  <button id="submitBtn" style="display:none;">Submit Verification</button>

  <p id="message"></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, sendEmailVerification, reload } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDlI255wuVSVsA0byWLZukBnQFz8p9TcYI",
      authDomain: "find-1-one.firebaseapp.com",
      projectId: "find-1-one",
      storageBucket: "find-1-one.appspot.com",
      messagingSenderId: "168713035092",
      appId: "1:168713035092:web:4427e042e98500d9a1bcc1",
      measurementId: "G-JBGGHT1SJ7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const camera = document.getElementById("camera");
    const canvas = document.getElementById("snapshot");
    const captureBtn = document.getElementById("captureBtn");
    const submitBtn = document.getElementById("submitBtn");
    const message = document.getElementById("message");
    const statusMsg = document.getElementById("statusMsg");

    let imageData = null;
    let currentUser = null;

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          camera.srcObject = stream;
          camera.style.display = "block";
          captureBtn.style.display = "inline-block";
        })
        .catch(err => { message.textContent = "Camera access denied."; });
    }

    captureBtn.addEventListener("click", () => {
      const context = canvas.getContext("2d");
      canvas.width = camera.videoWidth;
      canvas.height = camera.videoHeight;
      context.drawImage(camera, 0, 0, canvas.width, canvas.height);
      imageData = canvas.toDataURL("image/png"); // Base64 format
      camera.style.display = "none";
      canvas.style.display = "block";
      captureBtn.style.display = "none";
      submitBtn.style.display = "inline-block";
    });

    submitBtn.addEventListener("click", async () => {
      if (!currentUser || !imageData) {
        message.textContent = "Capture a photo first and ensure you are signed in.";
        return;
      }

      try {
        // Convert base64 to Blob
        const base64Data = imageData.split(",")[1];
        const byteCharacters = atob(base64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: "image/png" });

        // Prepare FormData
        const formData = new FormData();
        formData.append("file", blob, `${currentUser.uid}.png`);

        // Upload to Unlimited Storage API
        const url = "https://unlimited-cloud-storage.p.rapidapi.com/rapidapi/telegram/upload.php";
        const options = {
          method: "POST",
          headers: {
            "x-rapidapi-key": "82ae10db11mshb41ccacdd991130p108a22jsnf3ae22b94bbd",
            "x-rapidapi-host": "unlimited-cloud-storage.p.rapidapi.com"
          },
          body: formData
        };

        const response = await fetch(url, options);
        const result = await response.json(); // assuming JSON response
        console.log("Upload result:", result);

        // The API should return a file URL
        const photoURL = result.url || result.file || null;

        if (!photoURL) {
          throw new Error("No file URL returned from Unlimited Storage API");
        }

        // Update Firestore with verification info
        await updateDoc(doc(db, "users", currentUser.uid), {
          faceVerified: true,
          photoURL,
          updatedAt: new Date()
        });

        message.textContent = "Verification complete! Redirecting...";
        setTimeout(() => { window.location.href = "home.html"; }, 2000);

      } catch (err) {
        console.error(err);
        message.textContent = "Error saving verification.";
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        statusMsg.textContent = "You are not signed in. Redirecting to login...";
        setTimeout(() => window.location.href = "sign-in.html", 2000);
        return;
      }

      currentUser = user;
      await reload(user);

      if (user.emailVerified) {
        statusMsg.textContent = "Email verified! You can capture your photo now.";
        startCamera();
      } else {
        statusMsg.innerHTML = "Please verify your email first. Check your inbox and refresh this page after clicking the verification link.";
        await sendEmailVerification(user);
        camera.style.display = "none";
        captureBtn.style.display = "none";
      }
    });
  </script>
</body>
</html>
